"use strict";angular.module("photoCardsApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/preview/:cardid",{templateUrl:"views/preview.html",controller:"PreviewCtrl"}).when("/templates",{templateUrl:"views/templates.html",controller:"TemplatesCtrl"}).when("/editor",{templateUrl:"views/editor.html",controller:"EditorCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("photoCardsApp").controller("MainCtrl",["$scope","datafactory",function(a,b){FastClick.attach(document.body),a.cards=b.myCardsCollection,a.previewCardClick=function(a){location.href="#/preview/"+a.id}}]),angular.module("photoCardsApp").controller("PreviewCtrl",["$scope","$routeParams","datafactory",function(a,b,c){var d=b.cardid;a.card=_.findWhere(c.myCardsCollection,{id:parseInt(d)})}]),angular.module("photoCardsApp").controller("TemplatesCtrl",["$scope","$timeout","datafactory",function(a,b,c){a.templates=c.framesCollection,a.selectTemplate=function(a){c.selectedTemplate=a,location.href="#/editor"}}]),angular.module("photoCardsApp").controller("EditorCtrl",["$rootScope","$scope","datafactory","projectfactory","generateframefactory",function(a,b,c,d,e){function f(c){for(var d=0;d<c.length;d++){var e=new FileReader;e.onload=function(c){console.log("loaded >>"),b.project.template.placeholders[b.currentElementIndex].photo.url=c.target.result,a.$digest()},e.readAsDataURL(c[d])}}b.scale=1,b.boxwidth=1,b.boxheight=1,b.currentElementIndex=0;var g=d.createProject(c.selectedTemplate),h=function(c){console.log("image ulr>>"+c),b.project.template.placeholders[b.currentElementIndex].photo.url=event.target.result,a.$apply()},i=function(){};b.selectPhoto=function(){console.log("select photo >>"),navigator.camera.getPicture(h,i,{destinationType:Camera.DestinationType.FILE_URI,sourceType:Camera.PictureSourceType.PHOTOLIBRARY})},b.project=g,b.saveBtnClick=function(){b.$broadcast("save"),e.save(b.project)};var j=document.getElementById("fileupload");j.querySelector("input").onchange=function(){console.log("file >>"),f(this.files)},b.$on("changeImageIndex",function(a,c){b.currentElementIndex=c.index,console.log("changeImageIndex >>"+b.currentElementIndex)})}]),angular.module("photoCardsApp").directive("card",function(){return{restrict:"A",controller:"CardCtrl"}}).controller("CardCtrl",["$scope","$element",function(a,b){function c(){void 0!=l&&void 0!=l.photo&&void 0!=l.photo.url&&(m.panX=o=l.transform.panX*a.scale,m.panY=p=l.transform.panY*a.scale,m.rotate=l.transform.rotate,m.scale=l.transform.scale)}function d(){l.transform.panX=m.panX/a.scale,l.transform.panY=m.panY/a.scale,l.transform.scale=m.scale,l.transform.rotate=m.rotate}function e(){var b="translate3d("+l.transform.panX*a.scale+"px,"+l.transform.panY*a.scale+"px, 0) scale3d("+l.transform.scale+","+l.transform.scale+", "+l.transform.scale+") rotate("+l.transform.rotate+"deg)";k[0].style.transform=b,k[0].style.oTransform=b,k[0].style.msTransform=b,k[0].style.mozTransform=b,k[0].style.webkitTransform=b}function f(){d(),e()}function g(a){m.panX=o+a.deltaX,m.panY=p+a.deltaY,f(),"panend"==a.type&&(o=m.panX,p=m.panY)}function h(a){"pinchstart"==a.type&&(q=m.scale||1),m.scale=q*a.scale,f()}function i(a){"rotatestart"==a.type&&(r=m.rotate||0),m.rotate=r+a.rotation,f()}function j(){s=a.project.card.width*a.scale,t=a.project.card.height*a.scale,v=(a.boxwidth-s)/2+10,u=(a.boxheight-t)/2+60,b.css({width:s+"px",height:t+"px",top:u+"px",left:v+"px",position:"absolute"})}var k,l;a.setCurrentElementIndex=function(b){return a.currentElementIndex==b?!1:(a.$emit("changeImageIndex",{index:b}),k=$("#photo_"+b),l=a.project.template.placeholders[b],c(),void k.addClass("animated fadeIn").one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){k.removeClass("animated fadeIn")}))},a.$on("save",function(){null!=n&&(n.destroy(),n=null)}),a.$on("UpdateEditTransform",function(b,d){d.index==a.currentElementIndex&&c()});var m={panX:0,panY:0,scale:1,rotate:0},n=new Hammer.Manager(b[0]);n.add(new Hammer.Pan({threshold:0,pointers:0})),n.add(new Hammer.Rotate({threshold:0})).recognizeWith(n.get("pan")),n.add(new Hammer.Pinch({threshold:0})).recognizeWith([n.get("pan"),n.get("rotate")]),n.add(new Hammer.Tap({event:"singletap"})),n.on("panstart panmove panend",g),n.on("rotatestart rotatemove",i),n.on("pinchstart pinchmove",h),n.on("singletap",function(b){for(var c=b.center.x-v,d=b.center.y-u,e=0;e<a.project.template.placeholders.length;e++){var f=a.project.template.placeholders[e],g=(a.project.template.left+f.left)*a.scale,h=g+f.width*a.scale,i=(a.project.template.top+f.top)*a.scale,j=i+f.height*a.scale;if(c>=g&&h>=c&&d>=i&&j>=d){a.setCurrentElementIndex(e);break}}});var o=0,p=0,q=1,r=0;a.$on("orientationChange",function(){j(),c()});var s,t,u,v;j(),a.setCurrentElementIndex(0)}]),angular.module("photoCardsApp").directive("placeholder",function(){return{restrict:"A",template:'<img id="photo_{{$index}}" class="photoImage" url="{{photo.url}}" style="width: 100%;" imageonload/>',controller:"PlaceholderCtrl"}}).controller("PlaceholderCtrl",["$scope","$element",function(a,b){function c(){b.css({width:d.width*a.scale+"px",height:d.height*a.scale+"px",top:d.top*a.scale+"px",left:d.left*a.scale+"px",position:"absolute",overflow:"hidden",border:"1px solid red;"})}var d=a.placeholderdata;a.photo=a.placeholderdata.photo,a.$on("orientationChange",function(){c()}),c()}]),angular.module("photoCardsApp").factory("settingsdata",function(){var a=42;return{someMethod:function(){return a}}});var isMobile=!1;angular.module("photoCardsApp").directive("config",function(){return{restrict:"E",template:'<div id="xsCheck" class="visible-xs"></div>',replace:!0}}).controller("ConfigCtrl",function(){}),angular.module("photoCardsApp").factory("datafactory",function(){var a=42;return{someMethod:function(){return a},selectedTemplate:{},myCardsCollection:[{id:1,dateTime:"date",cardPreviewUrl:"images/RLPC.png",printImageUrl:""},{id:2,dateTime:"date",cardPreviewUrl:"images/RLPC.png",printImageUrl:""},{id:3,dateTime:"date",cardPreviewUrl:"images/RLPC.png",printImageUrl:""},{id:1,dateTime:"date",cardPreviewUrl:"images/RLPC.png",printImageUrl:""},{id:2,dateTime:"date",cardPreviewUrl:"images/RLPC.png",printImageUrl:""},{id:3,dateTime:"date",cardPreviewUrl:"images/RLPC.png",printImageUrl:""}],framesCollection:[{id:1,base:{width:1400,height:950,url:"images/2.png",top:50,left:50,orientation:"landscape",placeholders:[{width:400,height:400,top:50,left:50,photo:{}},{width:300,height:250,top:350,left:700,photo:{}}]},rotated:{width:1e3,height:1400,top:50,left:50,url:"images/2.png",orientation:"portrait",placeholders:[{width:100,height:100,top:200,left:300}]}},{id:1,base:{width:1400,height:950,url:"images/2.png",top:50,left:50,orientation:"landscape",placeholders:[{width:600,height:550,top:250,left:250,photo:{}}]},rotated:{width:1e3,height:1400,top:50,left:50,url:"images/2.png",orientation:"portrait",placeholders:[{width:100,height:100,top:200,left:300}]}},{id:1,base:{width:1400,height:950,url:"images/2.png",top:50,left:50,orientation:"landscape",placeholders:[{width:600,height:550,top:250,left:250,photo:{}}]},rotated:{width:1e3,height:1400,top:50,left:50,url:"images/2.png",orientation:"portrait",placeholders:[{width:100,height:100,top:200,left:300}]}}]}}),angular.module("photoCardsApp").factory("projectfactory",function(){var a={},b=1,c={landscape:{width:1500*b,height:1100*b,bgimage:"images/RLPC.png"},portrait:{width:1500,height:1100,bgimage:"images/portraitbg.png"}};return{getProject:function(){return a},createProject:function(b){return a={},a.template=angular.copy(b.base),a.card="portrait"===b.base.orientation?c.portrait:c.landscape,a.canRotate=void 0!==b.rotated,a},rotateTemplate:function(b){return a.template=b.base,a},getdefaulttransform:function(a){var b={panX:0,panY:0,scale:1,rotate:0},c=a.photo.width/a.photo.height,d=a.width/a.height,e=a.width/a.photo.width,f=a.photo.height*e;return c>d&&(b.scale=a.height/f),b.panY=(a.height-f)/2,b}}}),angular.module("photoCardsApp").directive("cardbgimage",function(){return{restrict:"A",controller:["$scope","$element",function(a,b){function c(){var c=a.project.card.width*a.scale,d=a.project.card.height*a.scale,e=0,f=0;b.css({width:c+"px",height:d+"px",top:f+"px",left:e+"0px",position:"absolute"})}a.$on("orientationChange",function(){c()}),c()}]}}),angular.module("photoCardsApp").directive("templateimage",function(){return{restrict:"A",controller:["$scope","$element",function(a,b){function c(){var c=a.project.template.width*a.scale,d=a.project.template.height*a.scale,e=a.project.template.left*a.scale,f=a.project.template.top*a.scale;b.css({width:c+"px",height:d+"px",top:f+"px",left:e+"px",position:"absolute"})}a.$on("orientationChange",function(){c()}),c()}]}}),angular.module("photoCardsApp").factory("generateframefactory",function(){var a,b,c,d=function(a,b){var c=document.getElementById("cardbgimage");a.drawImage(c,0,0,b.width,b.height)};return{save:function(e){var f=1;void 0==c?(c=document.createElement("canvas"),c.width=e.card.width*f,c.height=e.card.height*f,c.style.zIndex=8,c.style.position="absolute",c.style.border="1px solid red",c.style.display="none",a=c.getContext("2d")):a.clearRect(0,0,e.card.width,e.card.height),b=e,d(a,e.card);var g=c.toDataURL(),h=new FileTransfer,i="cdvfile://localhost/com.milkbooks.milkphotobooks/persistent/path/to/img.png";h.download(g,i,function(a){alert("download complete: "+a.fullPath),console.log("download complete: "+a.fullPath)},function(a){alert("download error source "+a.source),console.log("download error source "+a.source),console.log("download error target "+a.target),console.log("upload error code"+a.code)})}}}),angular.module("photoCardsApp").directive("imageonload",function(){return{restrict:"A",controller:["$scope","$element","projectfactory",function(a,b,c){function d(){var c="translate3d("+a.placeholderdata.transform.panX*a.scale+"px,"+a.placeholderdata.transform.panY*a.scale+"px, 0) scale3d("+a.placeholderdata.transform.scale+","+a.placeholderdata.transform.scale+", "+a.placeholderdata.transform.scale+") rotate("+a.placeholderdata.transform.rotate+"deg)";b[0].style.transform=c,b[0].style.oTransform=c,b[0].style.msTransform=c,b[0].style.mozTransform=c,b[0].style.webkitTransform=c}var e=new Image;a.$watch(function(){return a.placeholderdata.photo.url},function(){e.src=a.placeholderdata.photo.url}),e.onload=function(){a.placeholderdata.photo.verticalSquash=1,a.placeholderdata.photo.width=e.width,a.placeholderdata.photo.height=e.height,a.placeholderdata.transform=c.getdefaulttransform(a.placeholderdata),b[0].src=e.src,d(),a.$emit("UpdateEditTransform",{index:a.$index})},a.$on("orientationChange",function(){a.placeholderdata.transform&&d()})}]}}),angular.module("photoCardsApp").directive("box",function(){return{restrict:"A",controller:"BoxCtrl"}}).controller("BoxCtrl",["$scope","$element","$timeout",function(a,b,c){function d(){var a="portrait";(-90==window.orientation||90==window.orientation)&&(a="landscape"),console.log(a),c(e,0)}var e=function(){var c=window.innerWidth-20,d=window.innerHeight-70;b.css({width:c+"px",height:d+"px",margin:"60px 10px 10px 10px"}),a.scale=c/d>a.project.card.width/a.project.card.height?d/a.project.card.height:c/a.project.card.width,a.boxwidth=c,a.boxheight=d,a.$broadcast("orientationChange")};window.addEventListener("orientationchange",d,!0),d()}]);